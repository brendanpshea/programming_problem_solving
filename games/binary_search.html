<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fixed: Java Binary Search Trace</title>
    <style>
        :root { --java-bg: #2d2d2d; --java-text: #f8f8f2; --java-highlight: #44475a; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 950px; width: 100%; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .array-container { display: flex; gap: 8px; margin: 30px 0; justify-content: center; height: 100px; align-items: flex-end; }
        .cell-wrapper { display: flex; flex-direction: column; align-items: center; width: 55px; }
        .cell { width: 45px; height: 45px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 6px; background: white; transition: 0.3s; }
        .index-label { font-size: 0.75rem; color: #777; margin-top: 4px; }
        .pointer-label { font-size: 0.85rem; font-weight: bold; color: #d32f2f; height: 20px; }
        .active { border-color: #2196f3; background: #e3f2fd; }
        .discarded { opacity: 0.25; }
        .mid-highlight { background-color: #ffb74d; border-color: #f57c00; }
        .found { background-color: #4caf50; color: white; transform: translateY(-5px); }
        .panels { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
        .code-block { background: var(--java-bg); color: var(--java-text); padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.9rem; border: 2px solid transparent;}
        .code-active { border-color: #4caf50; }
        .line { display: block; padding: 2px 8px; border-radius: 3px; border-left: 3px solid transparent; }
        .line-highlight { background: var(--java-highlight); border-left-color: #ff79c6; }
        .interaction-panel { background: #fffde7; border: 2px solid #fff59d; padding: 20px; border-radius: 8px; min-height: 200px; }
        input[type="number"] { padding: 8px; width: 80px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        .feedback { font-weight: bold; margin-top: 10px; }
        .correct { color: #2e7d32; }
        .incorrect { color: #d32f2f; }
        button { padding: 10px 18px; border-radius: 6px; border: none; background: #2196f3; color: white; font-weight: bold; cursor: pointer; margin-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h2>Java Binary Search: Fixed Logic Trace</h2>
    <p>Target Value: <b id="target-val">--</b></p>
    <div id="visualizer" class="array-container"></div>

    <div class="panels">
        <div class="code-block" id="java-code">
            <span class="line" id="line1">int low = 0;</span>
            <span class="line" id="line2">int high = arr.length - 1;</span>
            <span class="line" id="line3">while (low <= high) {</span>
            <span class="line" id="line4">&nbsp;&nbsp;int mid = low + (high - low) / 2;</span>
            <span class="line" id="line5">&nbsp;&nbsp;if (arr[mid] == target) return mid;</span>
            <span class="line" id="line6">&nbsp;&nbsp;if (arr[mid] < target) low = mid + 1;</span>
            <span class="line" id="line7">&nbsp;&nbsp;else high = mid - 1;</span>
            <span class="line" id="line8">}</span>
            <span class="line" id="line9">return -1;</span>
        </div>

        <div class="interaction-panel">
            <div id="status-display" style="font-family: monospace; margin-bottom: 10px;">
                low: <span id="s-low">?</span> | high: <span id="s-high">?</span> | mid: <span id="s-mid">?</span>
            </div>
            <p id="prompt-text">Loading...</p>
            <div id="input-area">
                <input type="number" id="user-input" placeholder="Value">
                <button id="submit-btn" onclick="checkAnswer()">Check Answer</button>
            </div>
            <div id="feedback" class="feedback"></div>
            <button id="next-btn" onclick="goToNextLine()" style="display:none; background:#4caf50;">Continue &rarr;</button>
        </div>
    </div>
</div>

<script>
    let data = [], low, high, mid, target, currentLine = 0, isComplete = false, isSorted = false;
    let expectedValue = null;

    function init() {
        data = Array.from({length: 8}, () => Math.floor(Math.random() * 90) + 10).sort((a,b)=>a-b);
        target = Math.random() > 0.5 ? data[Math.floor(Math.random() * 8)] : 99;
        low = undefined; high = undefined; mid = undefined;
        currentLine = 0; isComplete = false;
        document.getElementById('target-val').innerText = target;
        startSortingCheck();
    }

    function render() {
        const container = document.getElementById('visualizer');
        container.innerHTML = '';
        data.forEach((val, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'cell-wrapper';
            const pointer = document.createElement('div');
            pointer.className = 'pointer-label';
            let p = [];
            if(i === low) p.push('L'); if(i === high) p.push('H'); if(i === mid) p.push('M');
            pointer.innerText = p.join(',');
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerText = val;
            if (low !== undefined && high !== undefined) {
                if (i < low || i > high) cell.classList.add('discarded');
                else cell.classList.add('active');
            }
            if (i === mid) cell.classList.add('mid-highlight');
            if (isComplete && val === target && i === mid) cell.classList.add('found');
            wrapper.append(pointer, cell);
            const idx = document.createElement('div'); idx.className='index-label'; idx.innerText=`[${i}]`;
            wrapper.appendChild(idx);
            container.appendChild(wrapper);
        });
        document.getElementById('s-low').innerText = low ?? '?';
        document.getElementById('s-high').innerText = high ?? '?';
        document.getElementById('s-mid').innerText = mid ?? '?';
        document.querySelectorAll('.line').forEach(l => l.classList.remove('line-highlight'));
        if (currentLine > 0) document.getElementById('line' + currentLine).classList.add('line-highlight');
    }

    function startSortingCheck() {
        document.getElementById('prompt-text').innerText = "Step 0: Is the array sorted for Binary Search? (1=Yes, 0=No)";
        expectedValue = 1; 
        currentLine = 0;
        render();
    }

    function prepareQuestion() {
        const prompt = document.getElementById('prompt-text');
        const input = document.getElementById('user-input');
        input.value = '';
        document.getElementById('input-area').style.display = 'block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('feedback').innerText = '';

        switch(currentLine) {
            case 1: prompt.innerText = "Initialize 'low'. What is its value?"; expectedValue = 0; break;
            case 2: prompt.innerText = "Initialize 'high'. What is its value? (Length - 1)"; expectedValue = data.length - 1; break;
            case 3: prompt.innerText = `While Loop Check: Is ${low} <= ${high}? (1=True, 0=False)`; expectedValue = (low <= high) ? 1 : 0; break;
            case 4: prompt.innerText = `Calculate mid index: ${low} + (${high}-${low})/2`; expectedValue = Math.floor(low + (high - low) / 2); break;
            case 5: prompt.innerText = `If check: What is the value at arr[${mid}]?`; expectedValue = data[mid]; break;
            case 6: prompt.innerText = `Is arr[${mid}] (${data[mid]}) < target (${target})? (1=True, 0=False)`; expectedValue = (data[mid] < target) ? 1 : 0; break;
            case 7: prompt.innerText = "Update 'high'. What is the new value? (mid - 1)"; expectedValue = mid - 1; break;
            case 9: prompt.innerText = "Loop ended. What does the method return?"; expectedValue = -1; break;
        }
    }

    function checkAnswer() {
        const val = parseInt(document.getElementById('user-input').value);
        const fb = document.getElementById('feedback');
        if (val === expectedValue) {
            fb.innerText = "Correct!";
            fb.className = "feedback correct";
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            
            // CRITICAL: Update variables immediately after correct prediction
            if (currentLine === 1) low = 0;
            if (currentLine === 2) high = data.length - 1;
            if (currentLine === 4) mid = expectedValue; // This prevents the undefined error!
        } else {
            fb.innerText = "Try again! Trace carefully.";
            fb.className = "feedback incorrect";
        }
    }

    function goToNextLine() {
        if (currentLine === 0) { currentLine = 1; document.getElementById('java-code').classList.add('code-active'); }
        else if (currentLine === 1) currentLine = 2;
        else if (currentLine === 2) currentLine = 3;
        else if (currentLine === 3) { if (low > high) currentLine = 9; else currentLine = 4; }
        else if (currentLine === 4) currentLine = 5;
        else if (currentLine === 5) { if (data[mid] === target) { isComplete = true; } else { currentLine = 6; } }
        else if (currentLine === 6) { if (data[mid] < target) { low = mid + 1; currentLine = 3; mid = undefined; } else { currentLine = 7; } }
        else if (currentLine === 7) { high = mid - 1; currentLine = 3; mid = undefined; }
        else if (currentLine === 9) isComplete = true;

        if (isComplete) {
            document.getElementById('prompt-text').innerText = "Trace Finished! Great job.";
            document.getElementById('next-btn').style.display = 'none';
        } else {
            prepareQuestion();
        }
        render();
    }

    init();
</script>
</body>
</html>
